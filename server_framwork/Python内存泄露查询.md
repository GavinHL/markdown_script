
# Python内存泄露查询

```
需求背景
最近项目在压力测试期间，进程在运行中内存持续增加，物理内存很快就被消耗殆尽。为了服务器能持久提供服务，需要对内存进行诊断。
本文讨论Python层内存对象的检查，CPython扩展不在本文讨论范围。
```


Python垃圾回收机制背景：

Python利用引用计数进行垃圾回收，当引用为0时，对象会被虚拟机析构内存会被释放。环引用则需要通过 **标记-清除算法**(`Mark-Sweep`) 来销毁对象。如果对象实现了__del__方法，由于gc无法断定销毁是否会__del__，gc无法处理这类对象。


###需要处理的异常情况包括：
- 垃圾对象：gc概念上的垃圾对象
- 泄露对象：对象在逻辑上应该被销毁，但是有外部引用，导致对象没有销毁
- 环引用对象：环引用对象会增加gc的cpu消耗，会延长对象回收时间


###解决方法
1. 垃圾对象处理：Python类尽量不要实现__del__方法，用其他机制实现就能避免垃圾对象。
2. 泄露对象解决：需要对逻辑层面十分了解，能知道如何判断一个对象是否是为逻辑层面应该销毁的对象。一般而言，对象用一个属性来标识是否已销毁，利用`gc.getobject`遍历对象全集，一一通过标识进行判断就能找出不正常的对象。利用`objgraph.show_chain(objgraph.find_backref_chain(obj, objgraph.is_proper_module))`生成引用链，解除异常引用解决问题。
3. 环引用对象处理：先`gc.set_debug(gc.DEBUG_SAVEALL)`，然后`gc.collect()`，再通过对`gc.garbage`里的对象利用引用关系进DFS遍历，记录所有找到的环。对记录的环引用中的对象，在销毁的时候一一解除引用即可。


